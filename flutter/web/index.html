<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="縦読みツール">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="tateyomi_gigarizer">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>縦読み ギガライザー</title>
  <link rel="manifest" href="manifest.json">
</head>
<body>

  <!-- ファイルのダウンロード用 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

  <script>
    function saveCanvas(frameDatalistJson, canvasWidth, canvasHeight, fileName) {

      var frameDatalist = JSON.parse(frameDatalistJson);

      // var canvas = document.createElement('canvas');
      var canvas = document.getElementById("myCanvas");
      var ctx = canvas.getContext('2d');      
      canvas.width    = canvasWidth
		  canvas.height   = canvasHeight

      ctx.beginPath();
      ctx.rect(0, 0, canvasWidth, canvasHeight);
      ctx.fillStyle = "#FFFFFF";
      ctx.fill();
      ctx.closePath();

      for (frameDataIndex in frameDatalist){
        // 'position'    : { "x" : position.x, "y" : position.y },
        // 'size'        : { "width" : size.x * sizeRate, "height" : size.y * sizeRate },
        // 'imageSize'   : { "width" : size.x, "height" : size.y },
        // 'byteData'    : byteData,
        var frameData = frameDatalist[frameDataIndex];

        addImage(ctx, frameData)
      }

      window.setTimeout( function() {
        canvas.toBlob(function(blob) {
          saveAs(blob, fileName);
        });
      }, 500 );      
    }

    function addImage(ctx, frameData){
      var img = new Image();
      img.onload = function() {

        var startPosX = 0
        var startPosY = 0
        if(frameData["angle"] == 1){
          startPosX = frameData["size"]["height"];
          startPosY = 0;
        }
        if(frameData["angle"] == 2){
          startPosX = frameData["size"]["width"];
          startPosY = frameData["size"]["height"];
        }
        if(frameData["angle"] == 3){
          startPosX = 0;
          startPosY = frameData["size"]["width"];
        }

        ctx.save();
        ctx.translate( frameData["position"]["x"] + startPosX, frameData["position"]["y"] + startPosY );
        ctx.rotate(frameData["angle"] * Math.PI/2);
        ctx.drawImage(
          img, 
          0, 0, frameData["imageSize"]["width"], frameData["imageSize"]["height"], 
          0, 0, frameData["size"]["width"], frameData["size"]["height"],
        )
        ctx.restore();
      }

      img.src = frameData.byteData;
    }

  </script>

  <canvas id="myCanvas" style="display:none"></canvas>

  <script src="main.dart.js?version=20220319" type="application/javascript"></script>
</body>
</html>
